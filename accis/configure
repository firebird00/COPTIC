#!/bin/bash
# Configure script for accis.

# By default assume GNU compatible compiler and set no-backslash
NOBACKSLASH=-fno-backslash
# Compiler choice.
if [ "$COMPILER" == "" ] ; then
if [ -x "`which mpif77`" ] ; then
# By default use mpif77 and if it is based on GNU use nobackslash.
   echo Choosing compiler mpif77
   COMPILER="mpif77 -f77=g77"
   if [ -z "`mpif77 --version | grep GNU`" ] ; then
       NOBACKSLASH=
   fi
else
# Else use gfortran or g77.
   if [ -x "`which gfortran`" ] ; then
      echo Choosing compiler gfortran
      COMPILER=gfortran
   else
	if [ -x "`which g77`" ] ; then
     	   echo Choosing compiler g77
     	   COMPILER=g77
	else
	   COMPILER=$F77
	   NOBACKSLASH=
     	fi
   fi   
fi
else
   if [ -z "`$COMPILER --version | grep GNU`" ] ; then
      NOBACKSLASH=
   fi
fi

# Xlib choice.
if [ "`uname -m`" == "x86_64" ] ; then 
   Xlib=/usr/lib/
fi

# VECX choice
if [ -z "`ld -lGLU -o /dev/null 2>&1 | grep GLU`" ] ; then
   echo Choosing to use GLX driver
   VECX=vecglx
else 
   VECX=vecx
fi

# Threaded version?
if [ -f /usr/include/pthread.h ] ; then
    echo Pthreads available, but not used.
# Currently this works on thinkpad but not on (e.g.) horace.
#    echo Using pthreads.
#    Threading="-DPTHREADS"
fi

cat > makefile <<EOF
# This is the configured makefile, which is used for the full make.
################ DO NOT EDIT THIS FILE. EDIT Makefile #############
# Here we have stuff that we determine by configuration.
G77=$COMPILER
NOBACKSLASH=$NOBACKSLASH
THREADING=$Threading
XLIB=$Xlib
VECX=$VECX
# That ends by having the original Makefile tacked on the end.
###################################################################
EOF
cat Makefile >>makefile
